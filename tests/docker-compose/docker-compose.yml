version: '2.3'

services:
  runner:
    image: registry.gitlab.com/altinity-qa/clickhouse/cicd/clickhouse-operator:latest
    volumes:
      - "../../:/home/master/clickhouse-operator/"
    privileged: true
    healthcheck:
      test: kubectl get pods --namespace kube-system | grep clickhouse-operator | grep Running || exit 1
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 300s

    cap_add:
      - NET_ADMIN
      - NET_RAW

  # dummy service which does nothing, but allows to postpone
  # 'docker-compose up -d' till all dependecies will go healthy
  all_services_ready:
    image: hello-world
    privileged: true
    depends_on:
      runner:
        condition: service_healthy
